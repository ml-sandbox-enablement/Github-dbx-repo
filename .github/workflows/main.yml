# Code Generated by Sidekick is for learning and experimentation purposes only.
name: Run Databricks Job

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          # Code Generated by Sidekick is for learning and experimentation purposes only.
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Trigger job and wait
        env:
          DATABRICKS_HOST: https://dbc-adf4afbc-60f8.cloud.databricks.com
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          DATABRICKS_JOB_ID: 571171201328256
        run: |
          # Code Generated by Sidekick is for learning and experimentation purposes only.
          set -euo pipefail

          run_id=$(
            curl -sS -X POST "$DATABRICKS_HOST/api/2.1/jobs/run-now" \
              -H "Authorization: Bearer $DATABRICKS_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"job_id\": $DATABRICKS_JOB_ID}" | jq -r .run_id
          )
          echo "Started run_id=$run_id"

          while true; do
            resp=$(curl -sS "$DATABRICKS_HOST/api/2.1/jobs/runs/get?run_id=$run_id" \
              -H "Authorization: Bearer $DATABRICKS_TOKEN")

            life=$(echo "$resp" | jq -r .state.life_cycle_state)
            result=$(echo "$resp" | jq -r .state.result_state)
            msg=$(echo "$resp" | jq -r .state.state_message)

            echo "state=$life result=$result msg=$msg"

            if [[ "$life" == "TERMINATED" ]]; then
              [[ "$result" == "SUCCESS" ]] && exit 0
              echo "Run failed: $msg"
              exit 1
            fi

            sleep 15
          done
